// ============================================================================
// TOP BAR COMPONENT - FRAME TRAILS
// ============================================================================
// Menu bar matching annotator style

import { MaterialPalette } from "../material/ui/styling/material_palette.slint";
import {
    MaterialTypography,
} from "../material/ui/styling/material_typography.slint";
import {
    MaterialStyleMetrics,
} from "../material/ui/styling/material_style_metrics.slint";
import { MaterialText } from "../material/ui/components/material_text.slint";
import { Icon } from "../material/ui/components/icon.slint";
import { Icons } from "../material/ui/icons/icons.slint";
import { PopupMenu } from "../material/ui/components/menu.slint";

// ============================================================================
// MENU BUTTON COMPONENT
// ============================================================================
component MenuButton inherits Rectangle {
    in property <string> text;
    in property <bool> is-open;
    in property <color> bg-color: MaterialPalette.surface-container;
    in property <color> bg-hover-color: MaterialPalette.surface-container-high;
    in property <color> bg-active-color: MaterialPalette.primary-container;
    in property <color> text-color: MaterialPalette.on-surface;
    in property <color> text-active-color: MaterialPalette.on-primary-container;
    callback clicked();
    callback hovered();

    width: 60px;
    height: 32px;
    border-radius: 4px;
    background: root.is-open ? root.bg-active-color : (touch.has-hover ? root.bg-hover-color : root.bg-color);

    MaterialText {
        text: root.text;
        style: MaterialTypography.label-large;
        color: root.is-open ? root.text-active-color : root.text-color;
        horizontal-alignment: center;
        vertical-alignment: center;
    }

    touch := TouchArea {
        clicked => {
            root.clicked();
        }
        mouse-cursor: pointer;
        moved => {
            if (self.has-hover) {
                root.hovered();
            }
        }
    }
}

// ============================================================================
// ACTION BUTTON COMPONENT
// ============================================================================
component ActionButton inherits Rectangle {
    in property <string> text;
    in property <bool> enabled: true;
    in property <color> bg-color: MaterialPalette.primary-container;
    in property <color> bg-hover-color: MaterialPalette.primary;
    in property <color> bg-disabled-color: MaterialPalette.surface-container;
    in property <color> text-color: MaterialPalette.on-primary-container;
    in property <color> text-hover-color: MaterialPalette.on-primary;
    in property <color> text-disabled-color: MaterialPalette.outline;
    callback clicked();

    width: 90px;
    height: 32px;
    border-radius: 4px;
    background: !root.enabled ? root.bg-disabled-color : (touch.has-hover ? root.bg-hover-color : root.bg-color);

    MaterialText {
        text: root.text;
        style: MaterialTypography.label-large;
        color: !root.enabled ? root.text-disabled-color : (touch.has-hover ? root.text-hover-color : root.text-color);
        horizontal-alignment: center;
        vertical-alignment: center;
    }

    touch := TouchArea {
        enabled: root.enabled;
        clicked => {
            root.clicked();
        }
        mouse-cursor: root.enabled ? pointer : default;
    }
}

export component TopBar {
    // ========================================================================
    // CALLBACKS
    // ========================================================================
    callback file-add-folder();
    callback file-clear-queue();
    callback view-toggle-sidebar();
    callback view-theme-dark();
    callback view-theme-light();
    callback tools-settings();
    callback start-processing();
    callback stop-processing();

    // ========================================================================
    // PROPERTIES
    // ========================================================================
    in property <bool> is-processing: false;
    in property <bool> has-folders: false;

    // ========================================================================
    // MENU STATE
    // ========================================================================
    property <bool> file-menu-open: false;
    property <bool> view-menu-open: false;
    property <bool> tools-menu-open: false;
    property <bool> any-menu-open: root.file-menu-open || root.view-menu-open || root.tools-menu-open;

    min-height: 40px;

    Rectangle {
        background: MaterialPalette.surface;

        // Bottom border
        Rectangle {
            y: parent.height - 1px;
            height: 1px;
            background: MaterialPalette.outline-variant;
        }

        HorizontalLayout {
            padding-left: MaterialStyleMetrics.padding-12;
            padding-right: MaterialStyleMetrics.padding-12;
            padding-top: 4px;
            padding-bottom: 4px;

            // ================================================================
            // LEFT SECTION - MENUS
            // ================================================================
            HorizontalLayout {
                spacing: 4px;
                alignment: start;

                file-menu-button := MenuButton {
                    text: "File";
                    is-open: root.file-menu-open;
                    bg-color: MaterialPalette.primary-container;
                    bg-hover-color: MaterialPalette.primary-container;
                    bg-active-color: MaterialPalette.primary;
                    text-color: MaterialPalette.on-primary-container;
                    text-active-color: MaterialPalette.on-primary;
                    clicked => {
                        root.view-menu-open = false;
                        root.tools-menu-open = false;
                        root.file-menu-open = true;
                        view-menu.close();
                        tools-menu.close();
                        file-menu.show();
                    }
                    hovered => {
                        if (root.any-menu-open) {
                            root.view-menu-open = false;
                            root.tools-menu-open = false;
                            root.file-menu-open = true;
                            view-menu.close();
                            tools-menu.close();
                            file-menu.show();
                        }
                    }
                }

                view-menu-button := MenuButton {
                    text: "View";
                    is-open: root.view-menu-open;
                    bg-color: MaterialPalette.tertiary-container;
                    bg-hover-color: MaterialPalette.tertiary-container;
                    bg-active-color: MaterialPalette.tertiary;
                    text-color: MaterialPalette.on-tertiary-container;
                    text-active-color: MaterialPalette.on-tertiary;
                    clicked => {
                        root.file-menu-open = false;
                        root.tools-menu-open = false;
                        root.view-menu-open = true;
                        file-menu.close();
                        tools-menu.close();
                        view-menu.show();
                    }
                    hovered => {
                        if (root.any-menu-open) {
                            root.file-menu-open = false;
                            root.tools-menu-open = false;
                            root.view-menu-open = true;
                            file-menu.close();
                            tools-menu.close();
                            view-menu.show();
                        }
                    }
                }

                tools-menu-button := MenuButton {
                    text: "Tools";
                    is-open: root.tools-menu-open;
                    bg-color: MaterialPalette.secondary-container;
                    bg-hover-color: MaterialPalette.secondary-container;
                    bg-active-color: MaterialPalette.secondary;
                    text-color: MaterialPalette.on-secondary-container;
                    text-active-color: MaterialPalette.on-secondary;
                    clicked => {
                        root.file-menu-open = false;
                        root.view-menu-open = false;
                        root.tools-menu-open = true;
                        file-menu.close();
                        view-menu.close();
                        tools-menu.show();
                    }
                    hovered => {
                        if (root.any-menu-open) {
                            root.file-menu-open = false;
                            root.view-menu-open = false;
                            root.tools-menu-open = true;
                            file-menu.close();
                            view-menu.close();
                            tools-menu.show();
                        }
                    }
                }
            }

            // ================================================================
            // CENTER SPACER
            // ================================================================
            Rectangle {
                horizontal-stretch: 1;
            }

            // ================================================================
            // RIGHT SECTION - ACTIONS
            // ================================================================
            HorizontalLayout {
                spacing: 8px;
                alignment: end;

                ActionButton {
                    text: root.is-processing ? "Stop" : "Start";
                    enabled: root.has-folders;
                    bg-color: root.is-processing ? MaterialPalette.error-container : MaterialPalette.primary-container;
                    bg-hover-color: root.is-processing ? MaterialPalette.error : MaterialPalette.primary;
                    text-color: root.is-processing ? MaterialPalette.on-error-container : MaterialPalette.on-primary-container;
                    text-hover-color: root.is-processing ? MaterialPalette.on-error : MaterialPalette.on-primary;
                    clicked => {
                        if (root.is-processing) {
                            root.stop-processing();
                        } else {
                            root.start-processing();
                        }
                    }
                }
            }
        }
    }

    // ========================================================================
    // FILE MENU
    // ========================================================================
    file-menu := PopupMenu {
        x: file-menu-button.absolute-position.x;
        y: file-menu-button.absolute-position.y + file-menu-button.height;

        items: [
            { text: "Add Folder...", enabled: true },
            { text: "Clear Queue", enabled: true },
        ];

        activated(index) => {
            self.close();
            root.file-menu-open = false;
            if (index == 0) {
                root.file-add-folder();
            } else if (index == 1) {
                root.file-clear-queue();
            }
        }
    }

    // ========================================================================
    // VIEW MENU
    // ========================================================================
    view-menu := PopupMenu {
        x: view-menu-button.absolute-position.x;
        y: view-menu-button.absolute-position.y + view-menu-button.height;

        items: [
            { text: "Toggle Sidebar", enabled: true },
            { text: "Dark Theme", enabled: true },
            { text: "Light Theme", enabled: true },
        ];

        activated(index) => {
            self.close();
            root.view-menu-open = false;
            if (index == 0) {
                root.view-toggle-sidebar();
            } else if (index == 1) {
                root.view-theme-dark();
            } else if (index == 2) {
                root.view-theme-light();
            }
        }
    }

    // ========================================================================
    // TOOLS MENU
    // ========================================================================
    tools-menu := PopupMenu {
        x: tools-menu-button.absolute-position.x;
        y: tools-menu-button.absolute-position.y + tools-menu-button.height;

        items: [
            { text: "Settings...", enabled: true },
        ];

        activated(index) => {
            self.close();
            root.tools-menu-open = false;
            if (index == 0) {
                root.tools-settings();
            }
        }
    }
}
