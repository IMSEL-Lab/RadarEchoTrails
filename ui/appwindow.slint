// ============================================================================
// FRAME TRAILS GUI - MAIN WINDOW
// ============================================================================

import { MaterialPalette } from "material/ui/styling/material_palette.slint";
import {
    MaterialTypography,
} from "material/ui/styling/material_typography.slint";
import { MaterialText } from "material/ui/components/material_text.slint";
import { Icon } from "material/ui/components/icon.slint";
import { Icons } from "material/ui/icons/icons.slint";

import { AppTheme } from "app_theme.slint";
import { TopBar } from "components/top_bar.slint";
import { FolderQueue, FolderItem } from "components/folder_queue.slint";
import { SettingsPanel } from "components/settings_panel.slint";
import { ProgressPanel } from "components/progress_panel.slint";
import { BottomBar } from "components/bottom_bar.slint";

// ============================================================================
// RGB SLIDER COMPONENT
// ============================================================================
component RgbSlider inherits Rectangle {
    in property <string> label;
    in-out property <int> value: 0;
    in property <color> track-color: MaterialPalette.primary;
    height: 28px;

    HorizontalLayout {
        spacing: 8px;
        MaterialText {
            text: root.label;
            style: MaterialTypography.label-medium;
            color: MaterialPalette.on-surface;
            width: 16px;
            vertical-alignment: center;
        }

        Rectangle {
            horizontal-stretch: 1;
            height: 24px;
            Rectangle {
                y: (parent.height - self.height) / 2;
                height: 6px;
                border-radius: 3px;
                background: MaterialPalette.surface-container-highest;
            }

            Rectangle {
                x: 0;
                y: (parent.height - self.height) / 2;
                height: 6px;
                width: parent.width * (root.value / 255.0);
                border-radius: 3px;
                background: root.track-color;
            }

            Rectangle {
                x: parent.width * (root.value / 255.0) - 8px;
                y: (parent.height - self.height) / 2;
                width: 16px;
                height: 16px;
                border-radius: 8px;
                background: root.track-color;
                border-width: 2px;
                border-color: MaterialPalette.on-primary;
            }

            TouchArea {
                clicked => {
                    root.value = Math.clamp(Math.round(self.mouse-x / parent.width * 255), 0, 255);
                }
                moved => {
                    if (self.pressed) {
                        root.value = Math.clamp(Math.round(self.mouse-x / parent.width * 255), 0, 255);
                    }
                }
                mouse-cursor: pointer;
            }
        }

        Rectangle {
            width: 36px;
            height: 20px;
            border-radius: 4px;
            background: MaterialPalette.surface-container;
            MaterialText {
                text: root.value;
                style: MaterialTypography.label-small;
                color: MaterialPalette.on-surface;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }
    }
}

component PresetColor inherits Rectangle {
    in property <color> preset-color;
    callback clicked();
    width: 24px;
    height: 24px;
    border-radius: 4px;
    background: root.preset-color;
    border-width: touch.has-hover ? 2px : 0px;
    border-color: MaterialPalette.on-surface;
    touch := TouchArea {
        clicked => {
            root.clicked();
        }
        mouse-cursor: pointer;
    }
}

// ============================================================================
// MAIN APPLICATION WINDOW
// ============================================================================
export component AppWindow inherits Window {
    title: "Frame Trails Generator";
    min-width: 900px;
    min-height: 600px;
    background: MaterialPalette.background;

    in-out property <string> theme-setting: "dark";
    init => {
        if (root.theme-setting == "dark") {
            MaterialPalette.color-scheme = ColorScheme.dark;
        } else {
            MaterialPalette.color-scheme = ColorScheme.light;
        }
    }

    in-out property <[FolderItem]> folders: [];
    in-out property <int> selected-folder-index: -1;
    in-out property <int> history-length: 5;
    in-out property <int> threads: 0;
    in-out property <int> limit: 0;
    in-out property <int> bg-r: 0;
    in-out property <int> bg-g: 0;
    in-out property <int> bg-b: 0;
    in-out property <int> cur-r: 0;
    in-out property <int> cur-g: 255;
    in-out property <int> cur-b: 0;
    in-out property <int> hist-r: 255;
    in-out property <int> hist-g: 127;
    in-out property <int> hist-b: 0;
    in-out property <bool> is-processing: false;
    in-out property <bool> is-complete: false;
    in-out property <float> overall-progress: 0.0;
    in-out property <int> folders-completed: 0;
    in-out property <float> folder-progress: 0.0;
    in-out property <int> files-completed: 0;
    in-out property <int> files-total: 0;
    in-out property <string> current-file: "";
    in-out property <string> current-folder: "";
    in-out property <string> eta-text: "--:--";
    in-out property <float> files-per-second: 0.0;
    in-out property <string> status-text: "Ready";

    callback add-folder();
    callback remove-folder(int);
    callback move-folder-up(int);
    callback move-folder-down(int);
    callback clear-queue();
    callback start-processing();
    callback stop-processing();
    callback settings-changed(int, int, int, int, int, int, int, int, int, int, int, int);
    callback parse-hex(string);

    property <bool> help-visible: false;
    property <int> picker-active: 0;
    in-out property <int> picker-r: 0;
    in-out property <int> picker-g: 0;
    in-out property <int> picker-b: 0;

    property <[color]> preset-colors: [
        #000000,
        #1a1a1a,
        #333333,
        #4d4d4d,
        #666666,
        #808080,
        #999999,
        #b3b3b3,
        #cccccc,
        #ffffff,
        #ff0000,
        #00ff00,
        #0000ff,
        #ffff00,
        #ff00ff,
        #00ffff,
        #ff7f00,
        #7fff00,
        #00ff7f,
        #007fff,
        #7f00ff,
        #ff007f,
        #800000,
        #008000,
        #000080,
        #808000,
        #008080,
        #800080,
        #804000,
        #408000,
        #ffb3b3,
        #b3ffb3,
        #b3b3ff,
        #ffffb3,
        #ffb3ff,
        #b3ffff,
        #ffd9b3,
        #d9ffb3,
        #2196f3,
        #4caf50,
        #ff9800,
        #e91e63,
        #9c27b0,
        #607d8b,
        #795548
    ];

    VerticalLayout {
        TopBar {
            file-add-folder => {
                root.add-folder();
            }
            file-clear-queue => {
                root.clear-queue();
            }
            view-theme-dark => {
                root.theme-setting = "dark";
                MaterialPalette.color-scheme = ColorScheme.dark;
            }
            view-theme-light => {
                root.theme-setting = "light";
                MaterialPalette.color-scheme = ColorScheme.light;
            }
            show-help => {
                root.help-visible = !root.help-visible;
            }
        }

        HorizontalLayout {
            vertical-stretch: 1;
            Rectangle {
                width: 280px;
                background: MaterialPalette.surface-container-low;
                VerticalLayout {
                    FolderQueue {
                        vertical-stretch: 1;
                        folders: root.folders;
                        selected-index: root.selected-folder-index;
                        is-processing: root.is-processing;
                        has-folders: root.folders.length > 0;
                        add-folder => {
                            root.add-folder();
                        }
                        remove-folder(idx) => {
                            root.remove-folder(idx);
                        }
                        move-up(idx) => {
                            root.move-folder-up(idx);
                        }
                        move-down(idx) => {
                            root.move-folder-down(idx);
                        }
                        select-folder(idx) => {
                            root.selected-folder-index = idx;
                        }
                        start-processing => {
                            root.start-processing();
                        }
                        stop-processing => {
                            root.stop-processing();
                        }
                    }

                    Rectangle {
                        height: 1px;
                        background: MaterialPalette.outline-variant;
                    }

                    SettingsPanel {
                        vertical-stretch: 1;
                        history-length <=> root.history-length;
                        threads <=> root.threads;
                        limit <=> root.limit;
                        background-brush: Colors.rgb(root.bg-r, root.bg-g, root.bg-b);
                        current-brush: Colors.rgb(root.cur-r, root.cur-g, root.cur-b);
                        history-brush: Colors.rgb(root.hist-r, root.hist-g, root.hist-b);
                        settings-changed => {
                            root.settings-changed(root.history-length, root.threads, root.limit, root.bg-r, root.bg-g, root.bg-b, root.cur-r, root.cur-g, root.cur-b, root.hist-r, root.hist-g, root.hist-b);
                        }
                        edit-background-color => {
                            root.picker-r = root.bg-r;
                            root.picker-g = root.bg-g;
                            root.picker-b = root.bg-b;
                            root.picker-active = 1;
                        }
                        edit-current-color => {
                            root.picker-r = root.cur-r;
                            root.picker-g = root.cur-g;
                            root.picker-b = root.cur-b;
                            root.picker-active = 2;
                        }
                        edit-history-color => {
                            root.picker-r = root.hist-r;
                            root.picker-g = root.hist-g;
                            root.picker-b = root.hist-b;
                            root.picker-active = 3;
                        }
                    }
                }

                Rectangle {
                    x: parent.width - 1px;
                    width: 1px;
                    height: 100%;
                    background: MaterialPalette.outline-variant;
                }
            }

            Rectangle {
                horizontal-stretch: 1;
                background: MaterialPalette.surface-container-lowest;
                ProgressPanel {
                    overall-progress: root.overall-progress;
                    folders-completed: root.folders-completed;
                    folders-total: root.folders.length;
                    folder-progress: root.folder-progress;
                    files-completed: root.files-completed;
                    files-total: root.files-total;
                    current-file: root.current-file;
                    current-folder: root.current-folder;
                    eta-text: root.eta-text;
                    files-per-second: root.files-per-second;
                    is-processing: root.is-processing;
                    is-complete: root.is-complete;
                }
            }
        }

        BottomBar {
            status-text: root.status-text;
            folders-in-queue: root.folders.length;
            is-processing: root.is-processing;
            history-length: root.history-length;
            threads: root.threads;
        }
    }

    // COLOR PICKER MODAL
    if root.picker-active > 0: Rectangle {
        width: 100%;
        height: 100%;
        background: #000000aa;
        TouchArea {
            clicked => {
                root.picker-active = 0;
            }
        }

        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: 442px;
            height: 380px;
            border-radius: 16px;
            background: MaterialPalette.surface-container;
            clip: true;
            TouchArea { }

            VerticalLayout {
                padding: 20px;
                spacing: 12px;
                MaterialText {
                    text: root.picker-active == 1 ? "Background Color" : root.picker-active == 2 ? "Current Frame Color" : "History Color";
                    style: MaterialTypography.title-large;
                    color: MaterialPalette.on-surface;
                    horizontal-alignment: center;
                }

                HorizontalLayout {
                    spacing: 16px;
                    Rectangle {
                        width: 80px;
                        height: 80px;
                        border-radius: 12px;
                        background: Colors.rgb(root.picker-r, root.picker-g, root.picker-b);
                        border-width: 2px;
                        border-color: MaterialPalette.outline-variant;
                    }

                    VerticalLayout {
                        horizontal-stretch: 1;
                        spacing: 8px;
                        RgbSlider {
                            label: "R";
                            value <=> root.picker-r;
                            track-color: #ff4444;
                        }

                        RgbSlider {
                            label: "G";
                            value <=> root.picker-g;
                            track-color: #44ff44;
                        }

                        RgbSlider {
                            label: "B";
                            value <=> root.picker-b;
                            track-color: #4444ff;
                        }
                    }
                }

                HorizontalLayout {
                    spacing: 8px;
                    MaterialText {
                        text: "Hex:";
                        style: MaterialTypography.label-medium;
                        color: MaterialPalette.on-surface;
                        vertical-alignment: center;
                        width: 36px;
                    }

                    Rectangle {
                        horizontal-stretch: 1;
                        height: 36px;
                        border-radius: 6px;
                        background: MaterialPalette.surface-container-low;
                        border-width: 1px;
                        border-color: hex-input.has-focus ? MaterialPalette.primary : MaterialPalette.outline-variant;
                        hex-input := TextInput {
                            x: 10px;
                            width: parent.width - 20px;
                            height: parent.height;
                            text: "#000000";
                            font-size: 14px;
                            color: MaterialPalette.on-surface;
                            vertical-alignment: center;
                            accepted => {
                                root.parse-hex(self.text);
                            }
                        }
                    }

                    Rectangle {
                        width: 70px;
                        height: 36px;
                        border-radius: 6px;
                        background: hex-btn.has-hover ? MaterialPalette.primary : MaterialPalette.primary-container;
                        border-width: 1px;
                        border-color: MaterialPalette.primary;
                        hex-btn := TouchArea {
                            clicked => {
                                root.parse-hex(hex-input.text);
                            }
                            mouse-cursor: pointer;
                        }

                        MaterialText {
                            text: "Apply";
                            style: MaterialTypography.label-medium;
                            color: hex-btn.has-hover ? MaterialPalette.on-primary : MaterialPalette.on-primary-container;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }

                MaterialText {
                    text: "Presets";
                    style: MaterialTypography.label-medium;
                    color: MaterialPalette.on-surface-variant;
                }

                VerticalLayout {
                    spacing: 3px;
                    HorizontalLayout {
                        spacing: 3px;
                        for i in 15: PresetColor {
                            preset-color: root.preset-colors[i];
                            clicked => {
                                if (i == 0) {
                                    root.picker-r = 0;
                                    root.picker-g = 0;
                                    root.picker-b = 0;
                                }
                                if (i == 1) {
                                    root.picker-r = 34;
                                    root.picker-g = 34;
                                    root.picker-b = 34;
                                }
                                if (i == 2) {
                                    root.picker-r = 68;
                                    root.picker-g = 68;
                                    root.picker-b = 68;
                                }
                                if (i == 3) {
                                    root.picker-r = 102;
                                    root.picker-g = 102;
                                    root.picker-b = 102;
                                }
                                if (i == 4) {
                                    root.picker-r = 136;
                                    root.picker-g = 136;
                                    root.picker-b = 136;
                                }
                                if (i == 5) {
                                    root.picker-r = 170;
                                    root.picker-g = 170;
                                    root.picker-b = 170;
                                }
                                if (i == 6) {
                                    root.picker-r = 204;
                                    root.picker-g = 204;
                                    root.picker-b = 204;
                                }
                                if (i == 7) {
                                    root.picker-r = 255;
                                    root.picker-g = 255;
                                    root.picker-b = 255;
                                }
                                if (i == 8) {
                                    root.picker-r = 255;
                                    root.picker-g = 0;
                                    root.picker-b = 0;
                                }
                                if (i == 9) {
                                    root.picker-r = 0;
                                    root.picker-g = 255;
                                    root.picker-b = 0;
                                }
                                if (i == 10) {
                                    root.picker-r = 0;
                                    root.picker-g = 0;
                                    root.picker-b = 255;
                                }
                                if (i == 11) {
                                    root.picker-r = 255;
                                    root.picker-g = 255;
                                    root.picker-b = 0;
                                }
                                if (i == 12) {
                                    root.picker-r = 255;
                                    root.picker-g = 0;
                                    root.picker-b = 255;
                                }
                                if (i == 13) {
                                    root.picker-r = 0;
                                    root.picker-g = 255;
                                    root.picker-b = 255;
                                }
                                if (i == 14) {
                                    root.picker-r = 255;
                                    root.picker-g = 0;
                                    root.picker-b = 255;
                                }
                            }
                        }
                    }

                    HorizontalLayout {
                        spacing: 3px;
                        for i in 15: PresetColor {
                            preset-color: root.preset-colors[15 + i];
                            clicked => {
                                if (i == 0) {
                                    root.picker-r = 255;
                                    root.picker-g = 127;
                                    root.picker-b = 0;
                                }
                                if (i == 1) {
                                    root.picker-r = 127;
                                    root.picker-g = 255;
                                    root.picker-b = 0;
                                }
                                if (i == 2) {
                                    root.picker-r = 0;
                                    root.picker-g = 255;
                                    root.picker-b = 127;
                                }
                                if (i == 3) {
                                    root.picker-r = 0;
                                    root.picker-g = 127;
                                    root.picker-b = 255;
                                }
                                if (i == 4) {
                                    root.picker-r = 127;
                                    root.picker-g = 0;
                                    root.picker-b = 255;
                                }
                                if (i == 5) {
                                    root.picker-r = 255;
                                    root.picker-g = 0;
                                    root.picker-b = 127;
                                }
                                if (i == 6) {
                                    root.picker-r = 128;
                                    root.picker-g = 0;
                                    root.picker-b = 0;
                                }
                                if (i == 7) {
                                    root.picker-r = 0;
                                    root.picker-g = 128;
                                    root.picker-b = 0;
                                }
                                if (i == 8) {
                                    root.picker-r = 0;
                                    root.picker-g = 0;
                                    root.picker-b = 128;
                                }
                                if (i == 9) {
                                    root.picker-r = 128;
                                    root.picker-g = 128;
                                    root.picker-b = 0;
                                }
                                if (i == 10) {
                                    root.picker-r = 0;
                                    root.picker-g = 128;
                                    root.picker-b = 128;
                                }
                                if (i == 11) {
                                    root.picker-r = 128;
                                    root.picker-g = 0;
                                    root.picker-b = 128;
                                }
                                if (i == 12) {
                                    root.picker-r = 128;
                                    root.picker-g = 64;
                                    root.picker-b = 0;
                                }
                                if (i == 13) {
                                    root.picker-r = 64;
                                    root.picker-g = 128;
                                    root.picker-b = 0;
                                }
                                if (i == 14) {
                                    root.picker-r = 0;
                                    root.picker-g = 64;
                                    root.picker-b = 128;
                                }
                            }
                        }
                    }

                    HorizontalLayout {
                        spacing: 3px;
                        for i in 15: PresetColor {
                            preset-color: root.preset-colors[30 + i];
                            clicked => {
                                if (i == 0) {
                                    root.picker-r = 255;
                                    root.picker-g = 179;
                                    root.picker-b = 179;
                                }
                                if (i == 1) {
                                    root.picker-r = 179;
                                    root.picker-g = 255;
                                    root.picker-b = 179;
                                }
                                if (i == 2) {
                                    root.picker-r = 179;
                                    root.picker-g = 179;
                                    root.picker-b = 255;
                                }
                                if (i == 3) {
                                    root.picker-r = 255;
                                    root.picker-g = 255;
                                    root.picker-b = 179;
                                }
                                if (i == 4) {
                                    root.picker-r = 255;
                                    root.picker-g = 179;
                                    root.picker-b = 255;
                                }
                                if (i == 5) {
                                    root.picker-r = 179;
                                    root.picker-g = 255;
                                    root.picker-b = 255;
                                }
                                if (i == 6) {
                                    root.picker-r = 255;
                                    root.picker-g = 217;
                                    root.picker-b = 179;
                                }
                                if (i == 7) {
                                    root.picker-r = 217;
                                    root.picker-g = 255;
                                    root.picker-b = 179;
                                }
                                if (i == 8) {
                                    root.picker-r = 33;
                                    root.picker-g = 150;
                                    root.picker-b = 243;
                                }
                                if (i == 9) {
                                    root.picker-r = 76;
                                    root.picker-g = 175;
                                    root.picker-b = 80;
                                }
                                if (i == 10) {
                                    root.picker-r = 255;
                                    root.picker-g = 152;
                                    root.picker-b = 0;
                                }
                                if (i == 11) {
                                    root.picker-r = 233;
                                    root.picker-g = 30;
                                    root.picker-b = 99;
                                }
                                if (i == 12) {
                                    root.picker-r = 156;
                                    root.picker-g = 39;
                                    root.picker-b = 176;
                                }
                                if (i == 13) {
                                    root.picker-r = 96;
                                    root.picker-g = 125;
                                    root.picker-b = 139;
                                }
                                if (i == 14) {
                                    root.picker-r = 121;
                                    root.picker-g = 85;
                                    root.picker-b = 72;
                                }
                            }
                        }
                    }
                }

                HorizontalLayout {
                    spacing: 12px;
                    Rectangle {
                        horizontal-stretch: 1;
                        height: 44px;
                        border-radius: 8px;
                        background: cancel-touch.has-hover ? MaterialPalette.surface-container-highest : MaterialPalette.surface-container-high;
                        cancel-touch := TouchArea {
                            clicked => {
                                root.picker-active = 0;
                            }
                            mouse-cursor: pointer;
                        }

                        MaterialText {
                            text: "Cancel";
                            style: MaterialTypography.label-large;
                            color: MaterialPalette.on-surface;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    Rectangle {
                        horizontal-stretch: 1;
                        height: 44px;
                        border-radius: 8px;
                        background: apply-touch.has-hover ? MaterialPalette.primary : MaterialPalette.primary-container;
                        apply-touch := TouchArea {
                            clicked => {
                                if (root.picker-active == 1) {
                                    root.bg-r = root.picker-r;
                                    root.bg-g = root.picker-g;
                                    root.bg-b = root.picker-b;
                                } else if (root.picker-active == 2) {
                                    root.cur-r = root.picker-r;
                                    root.cur-g = root.picker-g;
                                    root.cur-b = root.picker-b;
                                } else if (root.picker-active == 3) {
                                    root.hist-r = root.picker-r;
                                    root.hist-g = root.picker-g;
                                    root.hist-b = root.picker-b;
                                }
                                root.picker-active = 0;
                                root.settings-changed(root.history-length, root.threads, root.limit, root.bg-r, root.bg-g, root.bg-b, root.cur-r, root.cur-g, root.cur-b, root.hist-r, root.hist-g, root.hist-b);
                            }
                            mouse-cursor: pointer;
                        }

                        MaterialText {
                            text: "Apply";
                            style: MaterialTypography.label-large;
                            color: apply-touch.has-hover ? MaterialPalette.on-primary : MaterialPalette.on-primary-container;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }
            }
        }
    }

    // HELP OVERLAY
    if root.help-visible: Rectangle {
        width: 100%;
        height: 100%;
        background: #000000aa;
        TouchArea {
            clicked => {
                root.help-visible = false;
            }
        }

        Rectangle {
            width: 400px;
            height: 340px;
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            border-radius: 12px;
            background: MaterialPalette.surface-container;
            VerticalLayout {
                padding: 20px;
                spacing: 12px;
                MaterialText {
                    text: "Settings Help";
                    style: MaterialTypography.headline-small;
                    color: MaterialPalette.on-surface;
                }

                Rectangle {
                    height: 1px;
                    background: MaterialPalette.outline-variant;
                }

                VerticalLayout {
                    spacing: 8px;
                    MaterialText {
                        text: "History Length - Number of previous frames to overlay.";
                        style: MaterialTypography.body-small;
                        color: MaterialPalette.on-surface;
                        wrap: word-wrap;
                    }

                    MaterialText {
                        text: "Threads - Parallel worker threads (0 = auto).";
                        style: MaterialTypography.body-small;
                        color: MaterialPalette.on-surface;
                        wrap: word-wrap;
                    }

                    MaterialText {
                        text: "Frame Limit - Maximum frames to process (0 = all).";
                        style: MaterialTypography.body-small;
                        color: MaterialPalette.on-surface;
                        wrap: word-wrap;
                    }

                    MaterialText {
                        text: "Background - Background color for output images.";
                        style: MaterialTypography.body-small;
                        color: MaterialPalette.on-surface;
                        wrap: word-wrap;
                    }

                    MaterialText {
                        text: "Current Frame - Color for the current frame outline.";
                        style: MaterialTypography.body-small;
                        color: MaterialPalette.on-surface;
                        wrap: word-wrap;
                    }

                    MaterialText {
                        text: "History - Color for historical frame trails.";
                        style: MaterialTypography.body-small;
                        color: MaterialPalette.on-surface;
                        wrap: word-wrap;
                    }
                }

                Rectangle {
                    vertical-stretch: 1;
                }

                Rectangle {
                    height: 36px;
                    border-radius: 8px;
                    background: MaterialPalette.primary;
                    TouchArea {
                        clicked => {
                            root.help-visible = false;
                        }
                        mouse-cursor: pointer;
                    }

                    MaterialText {
                        text: "Close";
                        style: MaterialTypography.label-large;
                        color: MaterialPalette.on-primary;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }
        }
    }
}
